@page "/finance/inflation-eats-debt"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Does inflation eat debt?</PageTitle>

<h1>Does Inflation Eat Debt?</h1>
<p class="lead">
    There is an idea that gets repeated a lot that inflation eats debt. This is not necessarily true.
    Inflation can eat debt, but it depends on the interest rate and the rate of inflation.
</p>
<p>
    When people say “don’t overpay, inflation will eat the debt”, they really mean:
    If the real (inflation-adjusted) interest rate on your mortgage is low or negative, the debt shrinks in real
    terms over time, so keeping cheap debt can make sense.
</p>
<p>
    This calculator lets you plug in the numbers so you can see for your self what works and what doesn't.
</p>

<div class="card-grid">
    <div class="card">
        <p class="card-title">Your Debt</p>
        <p class="card-text">The details of your Debt. e.g. a personal loan or a mortgage, etc.</p>
        <div class="parameter">
            <span>Type:</span>
            <input type="radio" id="debtLoan" name="debtType" value="Loan" checked="@(_debtType == "Loan")" @onchange="@(() => OnDebtTypeChanged("Loan"))" />
            <label for="debtLoan">Loan</label>
            <input type="radio" id="debtMortgage" name="debtType" value="Mortgage" checked="@(_debtType == "Mortgage")" @onchange="@(() => OnDebtTypeChanged("Mortgage"))" />
            <label for="debtMortgage">Mortgage</label>
        </div>
        <div class="parameter">
            <span>Amount:</span>
            <input type="number" placeholder="£" id="loanAmount" @bind="_debtAmount" @oninput="OnInputChanged" />
        </div>
        <div class="parameter">
            <span>Interest rate:</span>
            <input type="number" placeholder="%" id="loanInterestRate" @bind="_debtInterestRate" @oninput="OnInputChanged" />
        </div>
        <div class="parameter">
            <span>Term:</span>
            <input type="number" placeholder="years" id="loanTerm" @bind="_debtTerm" @oninput="OnInputChanged" />
        </div>
    </div>
    <div class="card">
        <p class="card-title">Your situation</p>
        <p class="card-text">
            These are details about your financial position.
            How much you have to overpay the loan/mortgage or invest to keep up with inflation.
            What you expect your salary to rise by each year.
            How much you earn on your investments or savings.
        </p>
        <div class="parameter">
            <span>Available to overpay or invest:</span>
            <input type="number" placeholder="£" id="availableToOverpayOrInvest" @bind="_availableToOverpayOrInvest" @oninput="OnInputChanged" />
        </div>
        <div class="parameter">
            <span>Annual salary increase %:</span>
            <input type="number" placeholder="%" id="salaryIncrease" @bind="_salaryIncrease" @oninput="OnInputChanged" />
        </div>
        <div class="parameter">
            <span>Investment returns:</span>
            <input type="number" placeholder="%" id="investmentReturns" @bind="_investmentReturns" @oninput="OnInputChanged" />
        </div>
    </div>
    <div class="card">
        <p class="card-title">The Inflation Rate</p>
        <p class="card-text">These are the details of the rate of inflation.</p>
        <div class="parameter">
            <span>Inflation rate:</span>
            <input type="number" placeholder="%" id="inflationRate" @bind="_inflationRate" @oninput="OnInputChanged" />
        </div>
    </div>
</div>

<h2>Step 1: Your @_debtType in real terms.</h2>

<p>A good approximation of your real terms @_debtType interest rate is:</p>

<p class="maths">
    Real rate ≅ @FormattedDebtInterestRate - @FormattedInflationRate = @FormattedRealDebtInterestRate
</p>

<p>So, yes, inflation does reduce the real burden of your @_debtType.</p>

@if (RealDebtInterestRateIsPositive)
{
    <p>But notice that <strong>it is still positive</strong>. Inflation isn't eating it away completely.</p>
}
else
{
    <p>And notice that <strong>it is negative.</strong>. Inflation is eating away your @_debtType.</p>
}

<h2>Step 2: What overpaying actually earns you</h2>

<p>Every £1 you overpay on your @_debtType avoids @FormattedDebtInterestRate nominal interest, which is worth <strong>@FormattedRealDebtInterestRate</strong> in real terms.</p>

<p>That's a risk free return equivalent to a savings account paying @FormattedDebtInterestRate after tax. That's the benchmark you should compare everything to.</p>

@code {
    private string? _debtType;
    private decimal? _debtAmount;
    private decimal? _debtInterestRate;
    private decimal? _debtTerm;
    private decimal? _availableToOverpayOrInvest;
    private decimal? _salaryIncrease;
    private decimal? _investmentReturns;
    private decimal? _inflationRate;

    private string FormattedDebtInterestRate => DebtInterestRatePercent.ToString("P");
    private string FormattedInflationRate => InflationRatePercent.ToString("P");


    private decimal DebtInterestRatePercent => (_debtInterestRate ?? 0) / 100M;
    private decimal InflationRatePercent => (_inflationRate ?? 0) / 100M;

    private bool Step1Prerequisites => _debtAmount.HasValue && _debtInterestRate.HasValue && _inflationRate.HasValue;

    private decimal RealDebtInterestRate => DebtInterestRatePercent - InflationRatePercent;
    private string FormattedRealDebtInterestRate => RealDebtInterestRate.ToString("P");
    private bool RealDebtInterestRateIsPositive => RealDebtInterestRate > 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFromQueryString();
        }
    }

    private async Task LoadFromQueryString()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        _debtAmount = ParseDecimal(query["loanAmount"]);
        _debtType = query["debtType"];
        _debtInterestRate = ParseDecimal(query["loanInterestRate"]);
        _debtTerm = ParseDecimal(query["loanTerm"]);
        _availableToOverpayOrInvest = ParseDecimal(query["availableToOverpayOrInvest"]);
        _salaryIncrease = ParseDecimal(query["salaryIncrease"]);
        _investmentReturns = ParseDecimal(query["investmentReturns"]);
        _inflationRate = ParseDecimal(query["inflationRate"]);

        StateHasChanged();
    }

    private decimal? ParseDecimal(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return null;

        if (decimal.TryParse(value, out var result))
            return result;

        return null;
    }

    private async Task UpdateQueryString()
    {
        var parameters = new Dictionary<string, object?>
        {
            ["debtType"] = _debtType,
            ["loanAmount"] = _debtAmount,
            ["loanInterestRate"] = _debtInterestRate,
            ["loanTerm"] = _debtTerm,
            ["availableToOverpayOrInvest"] = _availableToOverpayOrInvest,
            ["salaryIncrease"] = _salaryIncrease,
            ["investmentReturns"] = _investmentReturns,
            ["inflationRate"] = _inflationRate
        };

        var queryString = string.Join("&", parameters
            .Where(p => p.Value != null)
            .Select(p => $"{p.Key}={p.Value}"));

        var newUrl = $"{NavigationManager.ToAbsoluteUri(NavigationManager.Uri).GetLeftPart(UriPartial.Path)}?{queryString}";
        NavigationManager.NavigateTo(newUrl, replace: true);
    }

    private async Task OnInputChanged()
    {
        await UpdateQueryString();
    }

    private async Task OnDebtTypeChanged(string value)
    {
        _debtType = value;
        await UpdateQueryString();
    }
}
